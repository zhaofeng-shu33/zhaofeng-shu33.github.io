<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>计原大实验完成感想</title>
    <link rel="stylesheet" href="../../../css/github-markdown.css">
    <style>
	.markdown-body {
		box-sizing: border-box;
		min-width: 200px;
		max-width: 980px;
		margin: 0 auto;
		padding: 45px;
	}

	@media (max-width: 767px) {
		.markdown-body {
			padding: 15px;
		}
	}
</style>
  </head>
  <article class="markdown-body">
	<h1>计算机原理大实验有感</h1>
<p>2016/12/1</p>
<blockquote>
<p><a href="https://github.com/Leidenschaft/Computer-Organization">https://github.com/Leidenschaft/Computer-Organization</a></p>
</blockquote>
<hr />
<p>现在是北京时间1:27分，我、姜伟峰、牛行知正坐在桥咖啡的狭小的桌子旁边等待名副其实的夜宵。
是夜也，凭借调试工程师牛神的敏锐直觉，纠正了我的一个关于用户地址错误，随即牛神在矩形边框深蓝
色背景的电脑终端上敲下几个简短的指令后，得到了用户程序执行后返回的反馈，然后牛神查看寄存器的指针，
发现Load 一个立即数的指令执行结果正确，至此，我们确认经过接近三周的努力，计原大实验的基本要求已经做完了。</p>
<p>桥咖啡里开着Heizung,光线也很充足，所以姜神随便点些什么千元会员卡就打个八折，在另外两位大神根据
五十步而止者的网原书面作业炮制自己的百步而止的作业时，我打开笔记本，回忆这三周来在大实验上的经过。
牛神说控制器是在不同的状态发射不同的控制信号的东西，刘卫东制造了押韵的课程口号，曰为“奋战三星期，造台计算机”，
李山山是专业生产教学计算机板子从而给做实验的同学带来潜在的质量问题的实验指导老师，牛神的舍友冯冠宇是把三星期刷成一星期的
大神中的大神。然而这些都是道听途说的东西，造计算机的个中曲折只有经历过才略知一二。</p>
<p>所谓造计算机，指的是用VHDL高级编程语言在大规模可编程逻辑器件FPGA上实现RISC的16位CPU。可选择的方案主要有多周期和流水两种，
我们组根据我一拍脑门的决定准备做多周期CPU，主要是我之前花了一个通宵阅读并仿真了网上某个多周期CPU的源代码，而实验指导书上面又有
多周期控制器观测实验的教程，当时以为只要把数据通路做好就OK了。于是在第一周开始后第五天，牛姜二人还没正式开始做时，我花了一个下午
写好了数据通路，又花了点时间跑通了一个指令的仿真测试，并特地为MicroProcessor.vhd的顶层设计封装了一层Layer叫MicroProcessor_Debug.vhd
用于硬件调试。第一个调试的晚上只有我和牛神，设计烧到硬件上发现Data_Path的时序有点问题，和单步时钟的下降沿触发不Match,而且
MicroProcessor_Debug的layer有bug.经过反复修改同时受多周期控制器观测实验的启发，我用一个按钮对16路led进行切换，实现显示Data_Path上
16个节点在每步的数据，两个7段显示数码管一个用来显示当前指令的状态（是取指还是译码还是...）另一个用来显示data_path节点的数值。
最初测试时是在片内开ram,程序可以随设计一起烧入，避免处理访问外设sram的时序问题。原本我是用一个数码管显示当前是执行第几条指令，
在牛神的建议下改为显示当前指令的状态，确实在单条指令执行都不对的情况下原来的做法没有意义。尽管第一晚波折很多，但实际测试时我们
直接和仿真波形进行全盘对比，极大地减轻了人工校验数据通路节点数据在各步正确性的问题，而且Load Word指令执行正确。第一周周末在这样
良好的开端下我们实现了七条基本指令，以为实验快做完了。</p>
<p>下周一在我某次测试BEQZ时，突然发现它总是跳转，仿真结果是ALU总是给Controller传ZERO标志位为0，我只好修改Data_Path上器件是时钟下降沿触发
还是上升沿触发，但即使把BEQZ改对了，有的指令又执行不对了，产生了时序冲突，比如数据还没传到Memory的入口MemWrite就被使能，Store
Word指令就存了错误的数据。无奈之下我加了一个比较复杂的矫正模块，虽然是时钟高电平触发，但仿真似乎没啥问题。当时以为硬件会和
仿真一样。然而调硬件总是不对，一个晚上的努力后终于确认在时钟沿检测的Process中再检测时钟的高电平可能是不被允许的，后来想到应该
可以另开一个Process检测时钟下降沿，同时完成控制信号的及时更新。硬件几经调试，终于解决了BEQZ的问题。然而第二周时间已经过半。
为保险起见，在修改Data_Path和controller后，又要把之前的指令再测一遍。在这期间我阅读了FlashRam的例子，把它的用串口读写sram的模块
集成到microprocessor的内存下，同时改用外设sram作内存，这样就可以用串口调试助手手动下载程序和数据到内存中，
避免了每次测新指令还要重新综合vhd文件重新烧写芯片的麻烦，然而这样做比较麻烦的一点是，读写串口要先发指令，再发低位地址、高位地址，..
手动操作很麻烦，时间到了周末，牛、姜二人其他课程的deadline又多，我也有其他事，就耽搁了一些。周末我仅仅完成了阅读终端程序源代码，
并根据源代码制造自己的下载器myport.exe,实现自动下载程序和数据的功能。这其中电脑端发送数据的间隔延时也是调了很长时间，
其中一个比较大的教训是我在拷贝data_path时，误把仿真级的data_path替换掉吧硬件级的data_path,由于二者命名上有所出入，特别在时钟上很难区分，
导致我跑硬件总是出错，调试了一下午才发现问题所在。</p>
<p>周日晚上，牛神根据终端程序源代码自制了汇编器，可以完成简单的汇编功能，避免了手写机器码的麻烦。与此同时，姜神发挥程序员
鼓励师的重要作用，每晚自掏腰包给我和牛神提供饮食补贴。在8条基本指令的基础上，我简单地修改了数据通路，支持了其他4类指令，同时将
算逻运算指令缩短到3个时钟周期完成，牛神在此基础上将Controller指令扩展到30条，他每做完一条就测一下，保证了指令的准确性。由于最终
的监控程序要与电脑通过串口通信，必须在内存管理模块增加对串口的支持，我发现由于自己对串口一的封装导致无法按照要求送标志位。于是考虑用
串口二，也是调试了很多次才实现串口二正确的读写。在单步时钟源下，串口二可以正常工作。但当CPU主频超过1000Hz,无法正常收发数据，又调试了
很长时间，才决定不能采用把标志位扔到数据总线上的做法，而应该另行映射标志位。在解决这个大bug后，多亏了牛神单步调试cpu的能力比较强，
最终我们的cpu在11.0592MHz的主频下可以与电脑终端正常通信并响应电脑终端发的指令。</p>
  <div style="text-align:center"><a href="https://zhaofeng-shu33.github.io">主页</a></div>
</article>
</html>
